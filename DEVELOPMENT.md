# OpAMP Platform å¼€å‘æŒ‡å—

**æœ€åæ›´æ–°**: 2025-10-22

æœ¬æ–‡æ¡£æ˜¯é¡¹ç›®çš„å¼€å‘æŒ‡å—ï¼ŒåŒ…å«æ¶æ„è®¾è®¡ã€æŠ€æœ¯å†³ç­–ã€å¼€å‘ç¯å¢ƒé…ç½®å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆã€‚

---

## ğŸ“‹ ç›®å½•

1. [é¡¹ç›®èƒŒæ™¯](#é¡¹ç›®èƒŒæ™¯)
2. [æŠ€æœ¯é€‰å‹](#æŠ€æœ¯é€‰å‹)
3. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
4. [æŠ€æœ¯å†³ç­– (ADR)](#æŠ€æœ¯å†³ç­–-adr)
5. [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
6. [å¼€å‘ç¯å¢ƒé…ç½®](#å¼€å‘ç¯å¢ƒé…ç½®)
7. [å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ](#å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ)
8. [æœ¯è¯­è¡¨](#æœ¯è¯­è¡¨)

---

## ğŸŒ± é¡¹ç›®èƒŒæ™¯

### ä¸ºä»€ä¹ˆéœ€è¦ OpAMP Platformï¼Ÿ

åœ¨å¯è§‚æµ‹æ€§é¢†åŸŸï¼Œç®¡ç†å¤§è§„æ¨¡çš„é¥æµ‹ Agentï¼ˆTelemetry Agentsï¼‰æ˜¯ä¸€ä¸ªå…³é”®æŒ‘æˆ˜ï¼š

**ä¸»è¦ç—›ç‚¹**ï¼š
1. **é…ç½®ç®¡ç†å¤æ‚** - æ•°åƒä¸ª Agent çš„é…ç½®éš¾ä»¥ç»Ÿä¸€ç®¡ç†
2. **ç‰ˆæœ¬æ§åˆ¶å›°éš¾** - Agent ç‰ˆæœ¬åˆ†æ•£ï¼Œå‡çº§æµç¨‹ä¸ç»Ÿä¸€
3. **çŠ¶æ€ç›‘æ§ç¼ºå¤±** - æ— æ³•å®æ—¶äº†è§£ Agent çš„è¿è¡ŒçŠ¶æ€
4. **æ‰‹åŠ¨æ“ä½œç¹ç** - é…ç½®å˜æ›´éœ€è¦é€ä¸ª Agent æ“ä½œ

**OpAMP åè®®çš„ä»·å€¼**ï¼š
- **æ ‡å‡†åŒ–** - OpenTelemetry å®˜æ–¹å®šä¹‰çš„ Agent ç®¡ç†åè®®
- **è‡ªåŠ¨åŒ–** - è¿œç¨‹é…ç½®åˆ†å‘ã€ç‰ˆæœ¬å‡çº§
- **å¯è§‚æµ‹** - Agent çŠ¶æ€å®æ—¶ä¸ŠæŠ¥
- **çµæ´»æ€§** - æ ‡ç­¾é€‰æ‹©å™¨å®ç°ç»†ç²’åº¦æ§åˆ¶

### é¡¹ç›®ç›®æ ‡

æ„å»ºä¸€ä¸ªåŸºäº OpenTelemetry OpAMP åè®®çš„**ç°ä»£åŒ–ã€ç¨³å®šã€æ˜“æ‰©å±•**çš„ Agent ç®¡ç†å¹³å°ï¼š

1. **æ˜“ç”¨æ€§** - ç®€å•çš„ UI ç•Œé¢ï¼Œé™ä½ä½¿ç”¨é—¨æ§›
2. **å¯é æ€§** - ä¼ä¸šçº§æ•°æ®åº“ï¼Œé«˜å¯ç”¨éƒ¨ç½²
3. **å¯æ‰©å±•** - æ¸…æ™°çš„æ¶æ„ï¼Œæ”¯æŒå¤§è§„æ¨¡éƒ¨ç½²
4. **é•¿æœŸå‘å±•** - ä½¿ç”¨æœ€æ–°æŠ€æœ¯ï¼Œé¿å…æŠ€æœ¯å€ºåŠ¡

---

## ğŸ” æŠ€æœ¯é€‰å‹

### é¢ä¸´çš„é€‰æ‹©

é¡¹ç›®å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬ç ”ç©¶äº†ä¸¤ä¸ªä¸»è¦æ–¹æ¡ˆï¼š

#### æ–¹æ¡ˆ A: opamp-go (OpenTelemetry å®˜æ–¹)

**ä½ç½®**: https://github.com/open-telemetry/opamp-go

**ç‰¹ç‚¹**ï¼š
- âœ… OpenTelemetry å®˜æ–¹ç»´æŠ¤
- âœ… æŒç»­æ›´æ–°ï¼ˆæœ€åæ›´æ–°: 2025-10-01ï¼‰
- âœ… æœ€æ–° OpAMP åè®®æ”¯æŒ
- âœ… API æ¸…æ™°ï¼Œæ–‡æ¡£å®Œå–„
- âŒ ä»…æ˜¯åè®®åº“ï¼Œæ— å®Œæ•´åŠŸèƒ½
- âŒ éœ€è¦è‡ªå·±å®ç° UI å’Œä¸šåŠ¡é€»è¾‘

#### æ–¹æ¡ˆ B: bindplane-op (observIQ)

**ä½ç½®**: https://github.com/observIQ/bindplane-op

**ç‰¹ç‚¹**ï¼š
- âœ… åŠŸèƒ½å®Œæ•´ï¼ˆAgent ç®¡ç†ã€é…ç½®ç®¡ç†ã€UIï¼‰
- âœ… UI ç¾è§‚å®ç”¨
- âœ… æˆç†Ÿçš„æ¶æ„è®¾è®¡
- âœ… å¯ä»¥ç›´æ¥ä½¿ç”¨
- âŒ åœæ­¢ç»´æŠ¤ 3 å¹´ï¼ˆæœ€åæ›´æ–°: 2022-07-29ï¼‰
- âŒ ä¾èµ–è¿‡æ—¶ï¼ˆGo 1.18, opamp-go v0.2.0ï¼‰
- âŒ å¤§é‡æŠ€æœ¯å€ºåŠ¡

### æœ€ç»ˆå†³ç­–

**âœ… é€‰æ‹©ï¼šåŸºäº opamp-go v0.22.0 æ„å»ºæ–°å¹³å°**

**æ ¸å¿ƒç†ç”±**ï¼š

1. **ç¨³å®šæ€§ä¼˜å…ˆ**
   - å®˜æ–¹ç»´æŠ¤ï¼ŒæŒç»­æ›´æ–°
   - è·Ÿéš OpenTelemetry ç”Ÿæ€æ¼”è¿›
   - é¿å… 3 å¹´æŠ€æœ¯å€ºåŠ¡

2. **é•¿æœŸå‘å±•**
   - ä½¿ç”¨æœ€æ–°ç¨³å®šæŠ€æœ¯æ ˆ
   - API è®¾è®¡æ›´åŠ æ¸…æ™°
   - ç¤¾åŒºæ´»è·ƒï¼Œé—®é¢˜èƒ½å¾—åˆ°è§£å†³

3. **å­¦ä¹ ä¼˜ç§€è®¾è®¡**
   - æ·±å…¥åˆ†æ bindplane-op æ¶æ„
   - æå–å¯å¤ç”¨çš„è®¾è®¡æ¨¡å¼
   - é‡æ–°å®ç°ï¼Œè€Œä¸æ˜¯ fork

4. **è‡ªä¸»å¯æ§**
   - å®Œå…¨æŒæ¡ä»£ç åº“
   - å¯ä»¥æ ¹æ®éœ€æ±‚å®šåˆ¶
   - ä¸ä¾èµ–åœæ­¢ç»´æŠ¤çš„é¡¹ç›®

### ä» bindplane-op å­¦åˆ°çš„ç»éªŒ

é€šè¿‡æ·±å…¥åˆ†æ bindplane-opï¼Œæˆ‘ä»¬æå–äº†ä»¥ä¸‹ä¼˜ç§€è®¾è®¡ï¼š

**å‰ç«¯è®¾è®¡**ï¼š
- 3æ­¥é…ç½®å‘å¯¼
- åŒæ¨¡æ€ç¼–è¾‘å™¨ï¼ˆUI + YAMLï¼‰
- å®æ—¶çŠ¶æ€è®¢é˜…

**åç«¯æ¶æ„**ï¼š
- åˆ†å±‚æ¶æ„ï¼ˆAPI â†’ Manager â†’ Storeï¼‰
- Protocol æ¥å£æŠ½è±¡
- æ ‡ç­¾é€‰æ‹©å™¨ç³»ç»Ÿ
- EventBus äº‹ä»¶é€šçŸ¥

**OpAMP é›†æˆ**ï¼š
- per-connection callbacks
- çº¿ç¨‹å®‰å…¨çš„è¿æ¥ç®¡ç†
- é…ç½®å“ˆå¸Œå˜æ›´æ£€æµ‹

è¿™äº›ç»éªŒæŒ‡å¯¼äº†æˆ‘ä»¬çš„æ¶æ„è®¾è®¡ã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯ UI Layer                         â”‚
â”‚  React 18 + TypeScript + MUI v6 + Vite                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ REST API + GraphQL + WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Gateway Layer                       â”‚
â”‚  â”œâ”€ REST API (Gin)                                          â”‚
â”‚  â”œâ”€ GraphQL (gqlgen) [è®¡åˆ’]                                 â”‚
â”‚  â””â”€ WebSocket (Gorilla)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ä¸šåŠ¡é€»è¾‘ Layer                          â”‚
â”‚  â”œâ”€ Agent Manager                                           â”‚
â”‚  â”œâ”€ Config Manager                                          â”‚
â”‚  â””â”€ Package Manager [è®¡åˆ’]                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   OpAMP Protocol Layer                       â”‚
â”‚          opamp-go v0.22.0                                   â”‚
â”‚  â”œâ”€ WebSocket Server                                        â”‚
â”‚  â””â”€ Message Handler                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å­˜å‚¨ Layer                              â”‚
â”‚  â”œâ”€ PostgreSQL (ä¸»æ•°æ®)                                     â”‚
â”‚  â”œâ”€ Redis (ç¼“å­˜/å®æ—¶çŠ¶æ€)                                   â”‚
â”‚  â””â”€ MinIO (Agent åŒ…å­˜å‚¨)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **åˆ†å±‚æ¶æ„**: æ¸…æ™°çš„å±‚æ¬¡åˆ’åˆ†ï¼ŒèŒè´£åˆ†ç¦»
2. **æ¥å£é©±åŠ¨**: ä½¿ç”¨æ¥å£å®šä¹‰ï¼Œæ˜“äºæµ‹è¯•å’Œæ›¿æ¢
3. **æ¨¡å—åŒ–**: ç‹¬ç«‹çš„åŠŸèƒ½æ¨¡å—ï¼Œä½è€¦åˆé«˜å†…èš
4. **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œé«˜å¯ç”¨éƒ¨ç½²

### æ•°æ®æ¨¡å‹è®¾è®¡

#### Agent æ¨¡å‹
```go
type Agent struct {
    ID              string      // UUID
    Name            string      // æœåŠ¡åç§°
    Type            string      // OS ç±»å‹
    Architecture    string      // CPU æ¶æ„
    Hostname        string      // ä¸»æœºå
    Version         string      // Agent ç‰ˆæœ¬
    Status          AgentStatus // è¿æ¥çŠ¶æ€
    ConnectedAt     *time.Time  // è¿æ¥æ—¶é—´
    DisconnectedAt  *time.Time  // æ–­å¼€æ—¶é—´
    Labels          Labels      // æ ‡ç­¾ (JSONB)
    ConfigurationName string    // å…³è”é…ç½®
    OpAMPState      []byte      // OpAMP çŠ¶æ€
    SequenceNumber  uint64      // åºåˆ—å·
}
```

**å…³é”®è®¾è®¡**:
- Labels ä½¿ç”¨ JSONB å­˜å‚¨ â†’ çµæ´»çš„æ ‡ç­¾ç³»ç»Ÿ
- Status æšä¸¾ç±»å‹ â†’ ç±»å‹å®‰å…¨çš„çŠ¶æ€ç®¡ç†
- SequenceNumber â†’ OpAMP åè®®æ¶ˆæ¯é¡ºåº

#### Configuration æ¨¡å‹
```go
type Configuration struct {
    Name        string              // é…ç½®åç§°
    DisplayName string              // æ˜¾ç¤ºåç§°
    Description string              // æè¿°
    ContentType string              // å†…å®¹ç±»å‹ (yaml/json)
    RawConfig   string              // åŸå§‹é…ç½®å†…å®¹
    ConfigHash  string              // SHA256 å“ˆå¸Œ
    Selector    map[string]string   // æ ‡ç­¾é€‰æ‹©å™¨ (JSONB)
    Platform    *PlatformConfig     // å¹³å°é…ç½®
}
```

**å…³é”®è®¾è®¡**:
- Selector ä½¿ç”¨ JSONB â†’ çµæ´»çš„æ ‡ç­¾åŒ¹é…
- ConfigHash è‡ªåŠ¨è®¡ç®— â†’ é…ç½®å˜æ›´æ£€æµ‹
- æ”¯æŒ YAML/JSON æ ¼å¼

### é…ç½®åˆ†å‘ç®—æ³•

```go
// Configuration.MatchesAgent
func (c *Configuration) MatchesAgent(agent *Agent) bool {
    if len(c.Selector) == 0 {
        return false  // ç©ºé€‰æ‹©å™¨ä¸åŒ¹é…ä»»ä½• Agent
    }
    return agent.Labels.Matches(c.Selector)
}

// Labels.Matches - å­é›†åŒ¹é…ç®—æ³•
func (l Labels) Matches(selector map[string]string) bool {
    for key, value := range selector {
        if l[key] != value {
            return false
        }
    }
    return true
}
```

**åŒ¹é…é€»è¾‘**:
- selector å¿…é¡»æ˜¯ agent labels çš„å­é›†
- æ”¯æŒå¤šæ ‡ç­¾ç»„åˆåŒ¹é…
- ç©º selector ä¸åŒ¹é…ä»»ä½• Agent

---

## ğŸ“ æŠ€æœ¯å†³ç­– (ADR)

### ADR-001: ä½¿ç”¨ PostgreSQL æ›¿ä»£ BoltDB

**æ—¥æœŸ**: 2025-10-22
**çŠ¶æ€**: âœ… å·²é‡‡çº³

#### èƒŒæ™¯
bindplane-op ä½¿ç”¨ BoltDB (åµŒå…¥å¼æ•°æ®åº“)ï¼Œä½†å­˜åœ¨ä»¥ä¸‹é™åˆ¶ï¼š
- å•æœºéƒ¨ç½²ï¼Œæ— æ³•æ°´å¹³æ‰©å±•
- å¹¶å‘æ€§èƒ½æœ‰é™
- å¤‡ä»½å’Œæ¢å¤å¤æ‚

#### å†³ç­–
ä½¿ç”¨ PostgreSQL 16 ä½œä¸ºä¸»æ•°æ®åº“

#### ç†ç”±
1. **ä¼ä¸šçº§å¯é æ€§** - æˆç†Ÿç¨³å®šï¼Œç”Ÿäº§éªŒè¯
2. **æ”¯æŒé›†ç¾¤å’Œå¤åˆ¶** - é«˜å¯ç”¨éƒ¨ç½²
3. **å¼ºå¤§çš„æŸ¥è¯¢èƒ½åŠ›** - æ”¯æŒå¤æ‚æŸ¥è¯¢å’Œç´¢å¼•
4. **JSONB æ”¯æŒ** - çµæ´»çš„ schema
5. **ä¸°å¯Œçš„å·¥å…·ç”Ÿæ€** - pgAdmin, pg_dump ç­‰

#### å½±å“
- âœ… æ”¯æŒé«˜å¯ç”¨éƒ¨ç½²
- âœ… æ›´å¥½çš„å¹¶å‘æ€§èƒ½
- âœ… æ ‡å‡† SQL æŸ¥è¯¢
- âŒ éœ€è¦ç‹¬ç«‹éƒ¨ç½²æ•°æ®åº“
- âŒ å¢åŠ è¿ç»´å¤æ‚åº¦

---

### ADR-002: ä½¿ç”¨æœ€æ–° opamp-go v0.22.0

**æ—¥æœŸ**: 2025-10-22
**çŠ¶æ€**: âœ… å·²é‡‡çº³

#### èƒŒæ™¯
bindplane-op ä½¿ç”¨ opamp-go v0.2.0 (2022)ï¼Œå®˜æ–¹å·²æ›´æ–°åˆ° v0.22.0

#### å†³ç­–
ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ opamp-go v0.22.0

#### ç†ç”±
1. **å®˜æ–¹æŒç»­ç»´æŠ¤** - OpenTelemetry å®˜æ–¹é¡¹ç›®
2. **API æ›´åŠ æ¸…æ™°** - per-connection callbacks
3. **æ”¯æŒæœ€æ–°åè®®ç‰¹æ€§** - è·Ÿéš OpAMP è§„èŒƒæ›´æ–°
4. **æ›´å¥½çš„é”™è¯¯å¤„ç†** - æ”¹è¿›çš„é”™è¯¯ç±»å‹å’Œæ—¥å¿—
5. **é•¿æœŸæŠ€æœ¯æ”¯æŒ** - é¿å…æŠ€æœ¯å€ºåŠ¡

#### API å˜åŒ–

| ç‰¹æ€§ | v0.2.0 | v0.22.0 | å˜åŒ– |
|------|--------|---------|------|
| **Callbacks** | `CallbacksStruct` | `Callbacks` + `ConnectionCallbacks` | åˆ†ç¦»ä¸ºè¿æ¥çº§å›è°ƒ |
| **OnConnecting** | è¿”å›ç®€å•å“åº” | è¿”å› `ConnectionCallbacks` | æ›´çµæ´»çš„å›è°ƒç®¡ç† |
| **Logger** | 2å‚æ•° `Debugf` | 3å‚æ•° `Debugf(ctx, ...)` | æ”¯æŒ context |

#### å½±å“
- âœ… é•¿æœŸæŠ€æœ¯æ”¯æŒ
- âœ… æœ€æ–°åè®®ç‰¹æ€§
- âœ… æ›´æ¸…æ™°çš„ API è®¾è®¡
- âŒ éœ€è¦é€‚é…æ–° API
- âŒ æ— æ³•ç›´æ¥å‚è€ƒ bindplane-op ä»£ç 

---

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### åç«¯

| ç»„ä»¶ | ç‰ˆæœ¬ | é€‰æ‹©ç†ç”± |
|------|------|----------|
| **Go** | 1.24 | æœ€æ–°ç¨³å®šç‰ˆï¼Œæ€§èƒ½ä¼˜ç§€ |
| **opamp-go** | v0.22.0 | å®˜æ–¹æœ€æ–°ç‰ˆï¼ŒæŒç»­æ›´æ–° |
| **Gin** | v1.11.0 | é«˜æ€§èƒ½ Web æ¡†æ¶ |
| **GORM** | v1.31.0 | æˆç†Ÿ ORMï¼Œæ˜“ç”¨ |
| **PostgreSQL** | 16 | ä¼ä¸šçº§æ•°æ®åº“ |
| **Redis** | 7 | é«˜æ€§èƒ½ç¼“å­˜ |
| **MinIO** | latest | S3 å…¼å®¹å­˜å‚¨ |
| **Zap** | v1.27.0 | é«˜æ€§èƒ½æ—¥å¿—åº“ |
| **Viper** | v1.21.0 | é…ç½®ç®¡ç† |

### å‰ç«¯ (è®¡åˆ’ä¸­)

| ç»„ä»¶ | ç‰ˆæœ¬ | é€‰æ‹©ç†ç”± |
|------|------|----------|
| **React** | 18 | æœ€æ–°ç¨³å®šç‰ˆ |
| **TypeScript** | 5 | ç±»å‹å®‰å…¨ |
| **Vite** | 5 | æé€Ÿæ„å»º |
| **MUI** | v6 | ä¼ä¸šçº§ç»„ä»¶åº“ |

### ä¸ bindplane-op çš„å¯¹æ¯”

| ç»„ä»¶ | bindplane-op | æ–°å¹³å° | æå‡ |
|------|--------------|--------|------|
| Go | 1.18 | 1.24 | +6 ä¸ªç‰ˆæœ¬ |
| opamp-go | v0.2.0 (2022) | v0.22.0 (2025) | +20 ä¸ªç‰ˆæœ¬ |
| æ•°æ®åº“ | BoltDB | PostgreSQL | å•æœºâ†’é›†ç¾¤ |
| ç¼“å­˜ | æ—  | Redis | æ–°å¢ |

---

## ğŸš€ å¼€å‘ç¯å¢ƒé…ç½®

### å‰ç½®è¦æ±‚

- Go 1.24+
- Docker & Docker Compose
- Git

### 1. å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/cc1024201/opamp-platform.git
cd opamp-platform
```

### 2. å¯åŠ¨åŸºç¡€æœåŠ¡

```bash
# å¯åŠ¨ PostgreSQL, Redis, MinIO
docker-compose up -d

# éªŒè¯æœåŠ¡çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

**æœåŠ¡ç«¯å£**:
- PostgreSQL: `localhost:5432`
- Redis: `localhost:6379`
- MinIO API: `localhost:9000`
- MinIO Console: `localhost:9001` (minioadmin/minioadmin123)

### 3. é…ç½®åç«¯

```bash
cd backend

# å®‰è£…ä¾èµ–
go mod download

# é…ç½®æ–‡ä»¶
cp config.yaml.example config.yaml
# æ ¹æ®éœ€è¦ä¿®æ”¹ config.yaml

# ç¼–è¯‘
go build -o bin/opamp-server ./cmd/server

# è¿è¡Œ
./bin/opamp-server
```

**é…ç½®è¯´æ˜** (`config.yaml`):
```yaml
server:
  port: 8080
  mode: debug  # debug | release

opamp:
  endpoint: /v1/opamp
  secret_key: ""  # ç•™ç©ºåˆ™ä¸éªŒè¯

database:
  host: localhost
  port: 5432
  user: opamp
  password: opamp123
  dbname: opamp_platform

redis:
  host: localhost
  port: 6379

minio:
  endpoint: localhost:9000
  access_key: minioadmin
  secret_key: minioadmin123
```

### 4. CI/CD é…ç½®

#### GitHub Actions

é¡¹ç›®ä½¿ç”¨ GitHub Actions è¿›è¡Œ CI/CDï¼Œé…ç½®æ–‡ä»¶ï¼š`.github/workflows/test.yml`

**åŒ…å«çš„ Job**:
1. **Test** - è¿è¡Œå•å…ƒæµ‹è¯•ï¼Œç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
2. **Lint** - golangci-lint ä»£ç è´¨é‡æ£€æŸ¥
3. **Build** - ç¼–è¯‘éªŒè¯

**è§¦å‘æ¡ä»¶**:
- Push åˆ° `main` æˆ– `develop` åˆ†æ”¯
- Pull Request åˆ° `main` æˆ– `develop` åˆ†æ”¯

#### Codecov

æµ‹è¯•è¦†ç›–ç‡è‡ªåŠ¨ä¸Šä¼ åˆ° Codecovï¼š
```yaml
- name: Upload coverage to Codecov
  uses: codecov/codecov-action@v3
  with:
    file: ./coverage.out
```

### 5. æœ¬åœ°å¼€å‘å·¥å…·

#### è¿è¡Œæµ‹è¯•
```bash
cd backend

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./internal/... -v

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
go test ./internal/... -cover -coverprofile=coverage.out

# æŸ¥çœ‹è¦†ç›–ç‡
go tool cover -func=coverage.out

# HTML è¦†ç›–ç‡æŠ¥å‘Š
go tool cover -html=coverage.out -o coverage.html
```

#### ä»£ç æ£€æŸ¥
```bash
# å®‰è£… golangci-lint
go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest

# è¿è¡Œ linter
golangci-lint run

# è‡ªåŠ¨ä¿®å¤
golangci-lint run --fix
```

---

## ğŸ› å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜ 1: JSONB å­—æ®µæ‰«æé”™è¯¯

**ç°è±¡**:
```
sql: Scan error on column index 6, name "selector":
unsupported Scan, storing driver.Value type []uint8 into type *map[string]string
```

**åŸå› **:
ä½¿ç”¨äº†é”™è¯¯çš„ GORM æ ‡ç­¾ `gorm:"type:jsonb"`

**è§£å†³æ–¹æ¡ˆ**:
```go
// âŒ é”™è¯¯
Selector map[string]string `json:"selector" gorm:"type:jsonb"`

// âœ… æ­£ç¡®
Selector map[string]string `json:"selector" gorm:"serializer:json"`
```

GORM éœ€è¦ `serializer:json` æ ‡ç­¾æ¥å¤„ç† Go ç»“æ„ä½“ä¸ PostgreSQL JSONB çš„è½¬æ¢ã€‚

**ä¿®å¤çš„æ–‡ä»¶**:
- `internal/model/agent.go` - Labels å­—æ®µ
- `internal/model/configuration.go` - Selector, Platform å­—æ®µ

---

### é—®é¢˜ 2: TLS é…ç½®é”™è¯¯

**ç°è±¡**:
```
tls: first record does not look like a TLS handshake
```

**åŸå› **:
`InsecureSkipVerify: true` åªè·³è¿‡è¯ä¹¦éªŒè¯ï¼Œä»å°è¯•å»ºç«‹ TLS è¿æ¥ã€‚
æœåŠ¡å™¨ä½¿ç”¨ `ws://` (éåŠ å¯† WebSocket)ï¼Œä¸æ”¯æŒ TLSã€‚

**è§£å†³æ–¹æ¡ˆ**:
```go
// âŒ é”™è¯¯ - ä»ä½¿ç”¨ TLS
if initialInsecureConnection {
    agent.tlsConfig = &tls.Config{
        InsecureSkipVerify: true,
    }
}

// âœ… æ­£ç¡® - å®Œå…¨ç¦ç”¨ TLS
if initialInsecureConnection {
    agent.tlsConfig = nil
}
```

**åè®®åŒ¹é…**:
- `ws://` â†’ `tlsConfig = nil`
- `wss://` â†’ `tlsConfig = &tls.Config{...}`

---

### é—®é¢˜ 3: Labels åŒ¹é…é€»è¾‘é”™è¯¯

**ç°è±¡**: ç©º selector åŒ¹é…äº†æ‰€æœ‰ Agent

**åŸå› **: åŒ¹é…å‡½æ•°æœªå¤„ç†ç©º selector çš„æƒ…å†µ

**è§£å†³æ–¹æ¡ˆ**:
```go
func (l Labels) Matches(selector map[string]string) bool {
    // ä¿®å¤ï¼šç©ºé€‰æ‹©å™¨ä¸åŒ¹é…ä»»ä½• Agent
    if len(selector) == 0 {
        return false
    }

    for key, value := range selector {
        if l[key] != value {
            return false
        }
    }
    return true
}
```

---

### é—®é¢˜ 4: Agent å¸¸é‡å‘½å

**ç°è±¡**: ç¼–è¯‘é”™è¯¯ `undefined: AgentStatusConnected`

**åŸå› **: å¸¸é‡å‘½åä¸ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ**:
```go
// âŒ é”™è¯¯
AgentStatusConnected

// âœ… æ­£ç¡®
StatusConnected
```

---

## ğŸ“š æœ¯è¯­è¡¨

| æœ¯è¯­ | è‹±æ–‡ | è¯´æ˜ |
|------|------|------|
| **OpAMP** | Open Agent Management Protocol | OpenTelemetry ä»£ç†ç®¡ç†åè®® |
| **Agent** | Telemetry Agent | é¥æµ‹ä»£ç†ï¼Œæ”¶é›†è§‚æµ‹æ•°æ®çš„å®¢æˆ·ç«¯ç¨‹åº |
| **Configuration** | Agent Configuration | Agent çš„é…ç½®ä¿¡æ¯ï¼ŒåŒ…å«é‡‡é›†å’Œå¤„ç†è§„åˆ™ |
| **Selector** | Label Selector | æ ‡ç­¾é€‰æ‹©å™¨ï¼Œç”¨äºåŒ¹é…ç‰¹å®šçš„ Agent |
| **Labels** | Labels | Agent çš„æ ‡ç­¾é›†åˆï¼Œç”¨äºåˆ†ç±»å’ŒåŒ¹é… |
| **JSONB** | JSON Binary | PostgreSQL çš„äºŒè¿›åˆ¶ JSON å­˜å‚¨ç±»å‹ |
| **GORM** | Go ORM | Go è¯­è¨€çš„å¯¹è±¡å…³ç³»æ˜ å°„æ¡†æ¶ |
| **ADR** | Architecture Decision Record | æ¶æ„å†³ç­–è®°å½• |
| **CI/CD** | Continuous Integration/Delivery | æŒç»­é›†æˆ/æŒç»­äº¤ä»˜ |

---

## ğŸ”— ç›¸å…³é“¾æ¥

- [OpAMP è§„èŒƒ](https://github.com/open-telemetry/opamp-spec)
- [opamp-go ä»“åº“](https://github.com/open-telemetry/opamp-go)
- [GORM æ–‡æ¡£](https://gorm.io/docs/)
- [Gin æ–‡æ¡£](https://gin-gonic.com/docs/)
- [PostgreSQL æ–‡æ¡£](https://www.postgresql.org/docs/)

---

**æ–‡æ¡£ç»´æŠ¤**: å½“æ¶æ„ã€æŠ€æœ¯æ ˆæˆ–å…³é”®å†³ç­–å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒåŠæ—¶æ›´æ–°æœ¬æ–‡æ¡£ã€‚
